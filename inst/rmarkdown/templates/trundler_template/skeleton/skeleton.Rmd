---
title: "Trundler Report Template"
output: html_document
---

<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, comment = NULL)
```

```{r libraries}
library(trundler) 
library(dplyr) 
library(stringr)
library(purrr)
library(tidyr)
library(ggplot2) 
library(gt)
library(glue)
```

This report demonstrates how you can quickly generate a report using the Trundler R package.    
    
```{r, include = FALSE}
# You can get an API key from https://rapidapi.com/datawookie/api/trundler
API_KEY <- Sys.getenv("TRUNDLER_KEY")
set_api_key(API_KEY)
```

```{r}
# Get a dataframe of all available retailers
retailer_df <- retailer() 
```

## View the retailer catalog

Trundler collects data from wide range of retailers.  Currently, there are `r length(retailer_df$retailer)` retailers in the Trundler catalog.  Here are the first ten.

<br>
```{r}
# View the first 10 retailers
gt(retailer_df[1:10, 1:4]) %>% 
  tab_header(title = md("**Trundler Retailer Catalog**"),
            subtitle = md("*The first ten retailers in the catalog*")) %>%
  cols_label(retailer_id = md("**Retailer ID**"),
             retailer = md("**Retailer**"),
             retailer_url = md("**URL**"),
             currency = md("**Currency**"))
```

<br>

## Track the price of a product at a specific retailer

It's possible to search a retailer for a product of interest.  Here, we've searched for Bovril products sold at Pick 'n Pay.

<br>

```{r}
# Use the retailer_id to search for Bovril products at a specific retailer (e.g. Pick 'n Pay)
all_bovril <- retailer_products(retailer_id = 9, product = "Bovril") %>%
  select(product_id, product, sku)

# Print table
gt(all_bovril) %>%
  tab_header(title = md("**All Bovril Products**"),
             subtitle = md("*At Pick 'n Pay*")) %>%
  cols_label(product_id = md("**Product ID**"),
             product = md("**Product**"),
             sku = md("**SKU**"))

```
<br>

As you can see, Pick 'n Pay sells a few different Bovril products.  Let's have a look at the price of the 250g product.  Here are the most recent price records.

<br>
```{r}
# Using the corresponding product ID, you can get the product and price data you're interested in. 
bovril_250g <- product(543374) 

# Add the historical price data and the retailer information
bovril_250g_prices <- product_prices(543374) %>%
  inner_join(bovril_250g, by = 'product_id') %>%
  inner_join(retailer_df, by = 'retailer_id') %>%
  select(date = time, product, retailer, starts_with('price')) %>%
  mutate(date = as.Date(date))

retailer <- bovril_250g_prices$retailer[1]
product <- bovril_250g_prices$product[1]

bovril_250g_prices %>% 
  select(date, starts_with("price")) %>%
  slice(1:10) %>%
  arrange(desc(date)) %>%
  gt() %>%
  tab_header(title = md(glue("**{product}**")),
             subtitle = md(glue("*At {retailer}*"))) %>%
  cols_label(date = md("**Date**"),
             price = md("**Price**"),
             price_promotion = md("**Promotional Price**"),
             price_effective = md("**Effective Price**"))
  
```

<br>

It's easier to digest how the price of Bovril has changed over time if we plot the data.

<br>
```{r}

ggplot(bovril_250g_prices, aes(x = date)) +
  geom_step(aes(y = price), lwd = 2, alpha = 0.5) +
  geom_point(aes(y = price), size = 4, alpha = 0.725) +
  scale_x_date(NULL, date_breaks = "2 weeks", date_labels = "%e %b") +
  scale_y_continuous("Price (ZAR)") +
  labs(
    title = bovril_250g_prices$product[1]
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 15, face = "italic"),
    axis.text.y = element_text(size = 10, angle = 90, hjust = 0.5),
    axis.text.x = element_text(size = 10),
    axis.title.y = element_text(size = 15),
    panel.grid.major.y = element_line(colour = "grey", size = 0.125)
  ) 

```

<br>

## Track average prices over time

It can be useful to track how the average price of a product changes over time.    
     
The first step is to search for the product of interest.  In this case, we've searched for all single pineapples of the "Queen" variety.  

<br>
```{r}
# Search the database
search_results <- products("queen pineapple", regex = FALSE)

# Join the search results to the retailer dataframe, use only single queen pineapples at South African retailers.
pineapple_products <- search_results %>%
  inner_join(retailer_df, by = 'retailer_id') %>%
  filter(!str_detect(product, "Juice|[:digit:]g|2|Pack|Half") ,
         currency == "ZAR") %>%
  arrange(retailer)

# View the results
pineapple_products %>% 
  select(product, retailer, sku) %>%
  unique() %>%
  gt() %>%
  tab_header(title = md("**Single Pineapples**"),
             subtitle = md("*Sold at South African retailers*")) %>%
  cols_label(product = md("**Product**"),
             retailer = md("**Retailer**"),
             sku = md("**SKU**"))
```

<br>

Now, let's retrieve the price histories for each of these products and combine them into one table.

<br>
```{r}
# Get the price data for these pineapple products
pineapple_prices <- map_dfr(pineapple_products$product_id, product_prices) %>%
  unnest(cols = c(price)) %>%
  mutate(date = as.Date(time)) %>%
  inner_join(pineapple_products, by = 'product_id') %>%
  select(date, product_id, sku, product, retailer, starts_with("price"))

# Consolidate the product price if any products have more than one product ID - this is where the SKU is really useful!
pineapple_consolidated <- pineapple_prices %>%
  group_by(date, sku) %>%
  summarise(price = mean(price), .groups = "drop")

# Print first few rows 
pineapple_consolidated %>% 
  slice(1:10) %>%
  gt() %>%
  tab_header(title = md("**Single Pineapples: Prices**"),
             subtitle = md("*First ten records*")) %>%
  cols_label(date = md("**Date**"),
             sku = md("**SKU**"),
             price = md("**Price**"))
```

<br>

As you can see, the date intervals are irregular, but we can interpolate the prices for any missing days before calculating the average price.

<br>
```{r}
# First, create a uniform sequence of dates
dates <- seq.Date(
  min(pineapple_consolidated$date),
  max(pineapple_consolidated$date),
  by = "day"
)

# Expand to cover full date range, interpolate prices for missing dates, and get the average price for each day
pineapple_summary <- complete(pineapple_consolidated, date = dates, nesting(sku)) %>%
  group_by(sku) %>%
  mutate(price_interpolate = approx(date, price, date, method = "constant", rule = 2)$y) %>%
  group_by(date) %>%
  summarise(avg_price = mean(price_interpolate))

# View the table
pineapple_summary %>%
  arrange(desc(date)) %>%
    slice(1:10) %>%
  gt() %>%
  tab_header(title = md("**Single Pineapples: Average Price**"),
             subtitle = md("*Past ten days*")) %>%
  cols_label(date = md("**Date**"),
             avg_price = md("**Average Price**"))
```

<br>

Finally, let's plot the average price!

<br>
```{r}

ggplot(pineapple_summary, aes(x = date)) +
  geom_line(aes(y = avg_price), lwd = 2, alpha = 0.75) +
  scale_x_date(NULL, date_breaks = "2 weeks", date_labels = "%e %b") +
  scale_y_continuous("Price (ZAR)") +
  labs(
    title = "Single Pineapples: Average Price",
    subtitle = "Sold in South Africa"
  ) +
  theme_classic() +
  theme(
    plot.title = element_text(size = 20, face = "bold"),
    plot.subtitle = element_text(size = 15, face = "italic"),
    axis.text.y = element_text(size = 10, angle = 90, hjust = 0.5),
    axis.text.x = element_text(size = 10),
    axis.title.y = element_text(size = 15),
    panel.grid.major.y = element_line(colour = "grey", size = 0.125)
  ) 
```
